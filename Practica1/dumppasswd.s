.data

# La ruta del fichero passwd
file:
    .ascii "/etc/passwd"

# Buffer para leer
buffer:
	.skip 512

# Error abiendo el archivo

open_error:
    .ascii "Error opening the file"


.global _start

.text


_start:
    jmp _open


_open:
	
	# Abrir el archivo

	# OpCode 2 (open) into rax
	movq $2, %rax
	
	# Movemos el filename to rdi (1st arg)
	movq $file, %rdi

	# Movemos a rsi el modo de lectura
	movq $0, %rsi

	# Movemos buffer size
	movq $0644, %rdx
	syscall

	# Movemos a r12 (local var) el contenido retornado por la syscall 
	movq %rax, %r12


	# Comprobaci√≥n de apertura
	cmpq $0, %rax
	jl _open_error

	# Si no ha habido error de apertura
	jmp _read_n_print_loop

_read_n_print_loop:
    
	# OpCode 0 (read) into rax
	movq $0, %rax 

	# File descriptor
	movq %r12, %rdi

	# Buffer
	movq $buffer, %rsi
	movq $512, %rdx			# Buffer size
	
	syscall

	# Check if it is eof
	cmpq $0, %rax
	
	# If %rax == 0, jump done
	je done

	movq %rax, %r15

	# Opcode 1 to write
	movq $1, %rax

	movq $1, %rdi	# File descriptor de stdout
	# Buffer
	movq $buffer, %rsi
	movq %r15, %rdx			# Buffer size 

	syscall

	jmp _read_n_print_loop
done:

	# OpCode close into rax
	movq $3, %rax			# Cerramos el fd
	movq %r12, %rdi
	syscall

	jmp exit


exit:
	
	# OpCode 60 to exit the program
	movq $60, %rax
	syscall

_open_error:

	# printeamos mensaje de error

	# OpCode 1 para write
	movq $1, %rax 			

	# Opcode 4 para stat
	movq $4, %rdi

	# Mensaje de error
	movq $open_error, %rsi

	# Longitud del mensaje
	movq $22, %rdx
	syscall


	# exit the program
	jmp exit